import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

# Rencontre 20 - Planification de t√¢ches

:::note R√©sum√© de la s√©ance

<Tabs>

<TabItem value="deroulement" label="üë®‚Äçüè´ D√©roulement du cours">

1. Planification de t√¢ches
2. TP2

</TabItem>

<TabItem value="exercices" label="üíª Exercices √† compl√©ter">

- TP2

</TabItem>

<TabItem value="ressources" label="üìö Ressources √† consulter">

La pr√©sentation PowerPoint est sur le Teams du cours, sous le canal G√©n√©ral > Fichiers > Supports de cours.

</TabItem>

</Tabs>

:::



## Le planificateur de t√¢ches

Le planificateur de t√¢ches sert, comme son nom l'indique, √† planifier des op√©rations sous Windows afin qu'elles d√©marrent automatiquement selon certains crit√®res et dans certaines conditions. Il est tr√®s utile dans de nombreux contextes, comme la planification de t√¢ches de maintenance r√©guli√®res, le d√©marrage d'op√©rations automatique au d√©marrage du syst√®me ou √† l'ouverture d'une session utilisateur, le nettoyage automatique de fichiers temporaires, la prise de sauvegardes r√©guli√®res, etc.

Avec l'interface graphique, on utilise la console MMC du planificateur de t√¢ches, `taskschd`, ou encore la console de gestion de l'ordinateur, `compmgmt.msc`.

![](./assets/r20/taskschd_01.png)

Les t√¢ches planifi√©es sont organis√©es sous forme d'arborescence. La racine (nomm√©e "biblioth√®que du planificateur de t√¢ches", ou simplement, **/**) contient un certain nombre de t√¢ches planifi√©es d√©j√† mises en place √† l'installation de Windows ou d'un logiciel, mais d'autres t√¢ches sont stock√©es dans des conteneurs sous la racine.

![](./assets/r20/taskschd_02.png)

Pour cr√©er une t√¢che √† l'aide de l'interface graphique, il suffit d'ouvrir le menu contextuel par un clic-droit sur le conteneur o√π cr√©er la t√¢che. Il existe deux mani√®re de cr√©er une t√¢che: simplifi√©e ("*cr√©er une t√¢che de base...*") et avanc√©e ("*cr√©er une t√¢che...*"). Il est pr√©f√©rable de ne pas choisir une t√¢che de base, puisque certaines options sont inaccessibles.

![](./assets/r20/taskschd_03.png)


### Composition d'une t√¢che planifi√©e

Une t√¢che planifi√©e est en ensemble de plusieurs √©l√©ments d'information. Ils sont assembl√©s ensemble pour former une t√¢che planifi√©e incrite dans le planificateur.

![](./assets/r20/taskschd_05.png)

- L'information d'enregistrement (**RegistrationInfo**) contient les propri√©t√©s de la t√¢che qui concernent son enregistrement dans le planificateur, comme le nom de la t√¢che, sa description et son emplacement dans l'arborescence du planificateur.

- Les d√©clencheurs (**Trigger**) d√©finissent dans quelle circonstance la t√¢che pourra √™tre lanc√©e. Par exemple, au d√©marrage de l'ordinateur, √† l'ouverture de session, √† chaque vendredi minuit, ou m√™me lorsqu'un √©v√©nement syst√®me est d√©tect√©. Il peut y en avoir plus d'un.

- Les actions (**Action**) d√©finissent une action (comme le lancement d'une commande ou d'un script) √† ex√©cuter chaque fois que la t√¢che est d√©clench√©e. Il peut y en avoir plusieurs.

- Le principal de s√©curit√© (**Principal**) d√©crit avec quelle identit√© (un compte utilisateur ou un groupe) la t√¢che sera lanc√©e. Si le principal est un compte utilisateur, alors c'est sous ce compte que la t√¢che sera ex√©cut√©e (comme si l'utilisateur l'avait fait manuellement). Si le principal est un groupe, la t√¢che sera lanc√©e au nom de l'utilisateur courant uniquement s'il est membre de ce groupe.

- Les param√®tres (**Settings**) d√©crivent diverses options concernant la t√¢che. Par exemple, la t√¢che doit-elle √™tre ex√©cut√©e m√™me si l'ordinateur tourne sur la batterie, ou le comportement √† adopter si la t√¢che √©choue.

![](./assets/r20/taskschd_04.png)

## Planification d'une t√¢che (GUI)

Voici les √©l√©ments importants √† configurer pour cr√©er une t√¢che planifi√©e au moyen de l'interface graphique.


### D√©clencheur (*Trigger*)

Une t√¢che planifi√©e comprend un ou plusieurs d√©clencheurs, c'est-√†-dire des √©v√©nements qui d√©marreront automatiquement la t√¢che.

![](./assets/r20/taskschd_trigger01.png)

Plusieurs types de d√©clencheurs sont disponibles:
- √Ä l'heure programm√©e
- √Ä l'ouverture de session
- Au d√©marage
- Apr√®s une p√©riode d'activit√© 
- Sur un √©v√©nement (syst√®me)
- Lors de la cr√©ation/modification de la t√¢che
- Au moment de la connexion √† une session utilisateur (par exemple, RDP)
- Au moment de la d√©connexion √† une session utilisateur
- Au verrouillage du poste de travail (Win+L)
- Au d√©verrouillage du poste de travail

### Action (*Action*)

Une t√¢che planifi√©e comprend une ou plusieurs actions qui seront lanc√©es lorsque la t√¢che sera d√©clench√©e. Le principal type d'action est le lancement d'une commande ("*d√©marrer un programme*").

![](./assets/r20/taskschd_action01.png)

Pour lancer une commande, il faut d√©finir trois param√®tres:

| Param√®tre | Description |
| -- | -- |
| Programme/script | Le nom ou chemin du fichier ex√©cutable √† appeler seulement. |
| Ajouter des arguments (facultatif) | Tous les arguments apr√®s le nom de l'ex√©cutable. |
| Commencer dans (facultatif) | Le r√©pertoire de travail dans lequel lancer la commande. |

Par exemple, pour qu'une t√¢che ex√©cute le script PowerShell `C:\Scripts\MonScript.ps1`, il faudrait que le nom du programme soit `powershell.exe` et que les arguments soient `-File C:\Scripts\MonScript.ps1 -ExecutionPolicy Bypass`.

![](./assets/r20/taskschd_action02.png)

:::tip
Pour conna√Ætre la syntaxe de la commande Powershell.exe, vous pouvez lancer `Powershell.exe /?` pour acc√©der √† la rubrique d'aide.

![](./assets/r20/taskschd_action03.png)
:::


### Conditions et param√®tres

Les onglets Conditions et Param√®tres contiennent des options suppl√©mentaires sur la t√¢che.

![](./assets/r20/taskschd_condition01.png)

![](./assets/r20/taskschd_parameters01.png)


### Forcer le lancement une t√¢che planifi√©e

On peut forcer l'ex√©cution d'une t√¢che planifi√©e directement par la console. C'est pratique pour la tester.

![](./assets/r20/taskschd_forceexec.png)

:::tip
Comme bien des consoles MMC, vous pouvez g√©rer les t√¢ches planifi√©es sur une machine distante √† partir de la console. Vous devez √™tre administrateur local de la machine distante, et les pare-feux doivent laisser passer le protocole MSRPC.

![](./assets/r20/taskschd_remote.png)
:::


## Gestion des t√¢ches planifi√©es en PowerShell

PowerShell offre un ensemble de commandes pour contr√¥ler, localement ou √† distance, les t√¢ches planifi√©es.

Pour ce faire, il y a plusieurs commandes √† faire, puisqu'il faut cr√©er chaque √©l√©ment de la t√¢che planifi√©e individuellement, puis les mettre ensemble pour l'enregistrer dans la biblioth√®que du planificateur de t√¢ches.

### D√©finir le d√©clencheur

Il existe plusieurs d√©clencheurs. Il suffit ici de cr√©er un nouveau d√©clencheur du type souhait√©. Il faut le stocker dans une variable.

![](./assets/r20/taskschd_posh_newtrigger.png)


### D√©finir l'action

Il faut d√©finir l'action, soit le programme a ex√©cuter. Tout comme avec l'interface graphique, le programme √† sp√©cifier dans le param√®tre -Execute n'est que l'ex√©cutable √† lancer. Si c'est un script PowerShell, alors on met "powershell.exe". Si c'est un autre programme, on met uniquement le nom du programme, sans ses arguments.

![](./assets/r20/taskschd_posh_newaction.png)


### D√©finir le principal

Le principal d√©signe l'utilisateur au nom duquel la t√¢che sera ex√©cut√©e.

Nous avons deux options:
- Sp√©cifier un compte utilisateur sp√©cifique (`-UserID`)
- Sp√©cifier un groupe (`-GroupID`)

![](./assets/r20/taskschd_posh_newprincipal.png)

Si le principal est un utilisateur, la t√¢che sera faite au nom de ce compte pr√©cis.

Si le principal est un groupe, la t√¢che sera faite au nom de l'utilisateur courant, uniquement si celui-ci fait partie du groupe. Lorsque le principal est un groupe, il est impossible que la t√¢che soit lanc√©e lorsque l'utilisateur n'est pas logg√©.


### Enregistrer la t√¢che planifi√©e

Une fois tous les √©l√©ments en place, il ne reste plus qu'√† enregistrer la t√¢che planifi√©e. On lui donne alors un nom, une description et un emplacement dans le planificateur, puis on lui donne une ou plusieurs actions, un ou plusieurs d√©clencheurs ainsi qu'un principal.

![](./assets/r20/taskschd_posh_register.png)


:::tip
Il est aussi possible de contr√¥ler les t√¢ches planifi√©es sur un ordinateur distant. On peut simplement passer par une session distante (PSSession) au moyen de la commande Invoke-Command.

![](./assets/r20/taskschd_posh_remote01.png)
:::
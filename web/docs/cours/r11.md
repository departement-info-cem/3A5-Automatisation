import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

# Rencontre 11 - Port√©e (et travail sur le TP1)

:::note R√©sum√© de la s√©ance

<Tabs>

<TabItem value="deroulement" label="üë®‚Äçüè´ D√©roulement du cours">

1. Pr√©sentation de la notion de port√©e (scope) en PowerShell
2. Travail sur le TP1

</TabItem>

<TabItem value="exercices" label="üíª Exercices √† compl√©ter">

- Travail sur le TP1

</TabItem>

<TabItem value="ressources" label="üìö Ressources √† consulter">

La pr√©sentation PowerPoint est sur le Teams du cours, sous le canal G√©n√©ral > Fichiers > Supports de cours.

</TabItem>

</Tabs>

:::


## Qu'est-ce que la port√©e (scope)?

La port√©e, ou √©tendue, ou *scope* en anglais, est le m√©canisme qui d√©finit dans quel cas une ressource PowerShell, comme une variable, une fonction ou un alias, est accessible √† l'ext√©rieur du script ou de la fonction duquel il a √©t√© cr√©√©.

La port√©e **globale** r√©f√®re √† la session PowerShell. Lorsqu'on d√©marre une session, par exemple en d√©marrant une fen√™tre PowerShell, tout ce qui y est cr√©√© est dans la port√©e globale.

Lorsqu'on d√©marre un script √† partir de cette session, les objets cr√©√©s dans le script sont contenus ne sont pas accessibles dans la session PowerShell apr√®s la fin de l'ex√©cution du script.

Lorsqu'on tente d'acc√©der √† un objet (comme la lecture d'une variable ou l'appel d'une fonction), PowerShell tente de trouver cet objet dans la port√©e courante (locale). S'il n'est pas d√©clar√© dans cette port√©e, PowerShell tentera de le trouver en remontant la hi√©rarchie jusqu'√† ce qu'il en trouve un qui soit d√©fini.

![Port√©es PowerShell](./assets/r11/scope09.png)


## Port√©e locale

Lorsqu'une variable est d√©clar√©e dans un script ou une fonction, elle poss√®de par d√©faut une port√©e **locale**, c'est √† dire qu'elle cessera d'exister lorsque son ex√©cution sera termin√©e.

![Variable de port√©e locale](./assets/r11/scope01.png)

Si on tente d'acc√©der √† une variable qui n'est pas d√©finie, alors PowerShell recherchera cette variable dans la port√©e du parent. Si plusieurs variables du m√™me nom existent dans diff√©rentes port√©es, c'est la plus proche qui est obtenue.

![H√©ritage des port√©es](./assets/r11/scope02.png)


## Port√©e script

On peut d√©clarer une variable dans une port√©e sup√©rieure en sp√©cifiant un pr√©fixe de port√©e. Par exemple, si on souhaite qu'une variable d√©finie dans une fonction de script puisse √™tre lue dans le script, √† l'ext√©rieur de la fonction, on lui ajoute un pr√©fixe `$script:`.

![image](./assets/r11/scope03.png)

Si la variable existe √† la fois dans la port√©e globale et dans la port√©e du script, la plus proche l'emporte.

![image](./assets/r11/scope04.png)

## Port√©e globale

Une variable globale existe partout dans la session PowerShell, y compris dans le terminal, dans le code d'un script ou dans une fonction comprise dans le script. On d√©finit une variable globale en lui donnant le pr√©fixe `$global:`.

![image](./assets/r11/scope05.png)


## Visibilit√© priv√©e

Quand on d√©finit une variable de port√©e locale, celle-ci sera quand m√™me accessible √† une port√©e enfant. Pour bloquer ce m√©canisme, on peut forcer une variable √† ce qu'elle soit inaccessible √† une port√©e enfant.

![image](./assets/r11/scope10.png)


## Dotsourcing

Il arrive qu'on veuille ex√©cuter un script ou une fonction dans la port√©e locale, de sorte que toutes les variables et fonctions qui y sont d√©clar√©es persistent apr√®s leur ex√©cution. On doit alors indiquer le caract√®re `.` avant de lancer le script. Cette op√©ration s'appelle le ***dotsourcing***.

![image](./assets/r11/scope07.png)

On peut √©galement *dotsourcer* une fonction de la m√™me mani√®re, m√™me si cette manoeuvre est tr√®s peu utile dans la majorit√© des cas.

![image](./assets/r11/scope06.png)


## Bonnes pratiques

Bien qu'il puisse √™tre tentant de permettre √† des fonctions ou des scripts de d√©clarer des variables qui puissent √™tre lues √† l'ext√©rieur, on doit autant que possible √©viter d'interf√©rer avec les port√©es PowerShell.

Rappelez-vous le principe de la bo√Æte noire. 

- Si votre script (ou votre fonction) a besoin d'une information ext√©rieure pour faire son travail, passez-lui en **param√®tre**;
- Si votre script (ou votre fonction) doit communiquer une information √† l'ext√©rieur, faites-la sortir par le pipeline.

:::tip
Si une fonction ou un script doit sortir plusieurs informations de nature diff√©rente, vous devriez encapsuler ces valeurs dans un `PSCustomObject` et sortir cet objet par le pipeline.

Au lieu de faire ceci:

```powershell
function Get-Bob {
    $global:Nom = "Bob"
    $global:Age = 42
}

Get-Bob

Write-Host ($global:Nom + " a " + $global:Age + " ans.")
```

Faites plut√¥t ceci:

```powershell
function Get-Bob {
    [PSCustomObject]@{
        Nom = "Bob"
        Age = 42
    }
}

$Bob = Get-Bob

Write-Host ($Bob.Nom + " a " + $Bob.Age + " ans.")
```
:::

Aussi, **affectez toujours vos variables** avant de les appeler. Si votre script assume qu'au d√©but de son ex√©cution, les variables n'existent pas, il pourrait arriver une situation probl√©matique lorsque celle-ci a √©t√© affect√©e dans la session en cours.


:::tip
Si vous voulez savoir si une variable existe √† la port√©e locale, vous pouvez tester son √©galit√© √† `$null`. Dans ce cas, par pr√©caution, utilisez le pr√©fixe `$local:` pour forcer l'utilisation de la variable locale.

```powershell
if ($null -ne $local:MaVariable) {
    # La variable $MaVariable existe dans la port√©e locale.
}
```
:::


:::danger
D√©finir des objets PowerShell, comme des variables, des fonctions et des alias, √† l'ext√©rieur de la port√©e locale peut conduire √† des probl√®mes. En voici une illustration:

![image](./assets/r11/scope11.png)

En l'apparence anodin, ce script d√©finit une fonction Get-ChildItem dans la port√©e global, ce qui a pour effet de surcharger la commande Get-ChildItem. Voici le code du script:

```powershell
Function global:Get-ChildItem {
    Write-Host "Mouahahaha j'ai hack√© PowerShell!!!" -ForegroundColor Red
}

Write-Host "Bonjour!"
```
:::


## R√©f√©rences

Voici quelques sites int√©ressants pour mieux comprendre le fonction des port√©es en PowerShell:

- [about Scopes - PowerShell | Microsoft Learn](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_scopes?view=powershell-5.1)

- [Guide de port√©e des variables dans PowerShell : Utilisation de la port√©e dans les scripts et les modules | Varonis](https://www.varonis.com/fr/blog/portee-variable-powershell
)

- [Windows PowerShell Fundamentals Chapter 13 - Scope - YouTube](https://www.youtube.com/watch?v=0CutdM6B_6U
)
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

# Rencontre 15 - Le registre de Windows

:::note R√©sum√© de la s√©ance

<Tabs>

<TabItem value="deroulement" label="üë®‚Äçüè´ D√©roulement du cours">

1. Retour sur l'examen intra
1. Les fournisseurs PowerShell et les PSDrives
1. Le registre de Windows
1. L'acc√®s au registre avec PowerShell

</TabItem>

<TabItem value="exercices" label="üíª Exercices √† compl√©ter">

Exercice 15 sur OneNote

</TabItem>

<TabItem value="ressources" label="üìö Ressources √† consulter">

La pr√©sentation PowerPoint est sur le Teams du cours, sous le canal G√©n√©ral > Fichiers > Supports de cours.

</TabItem>

</Tabs>

:::


## *PSProvider* et *PSDrive*

Les **fournisseurs PowerShell** (appel√©s *PSProvider*) sont des couches d'abstraction permettant d'obtenir des donn√©es de diff√©rentes natures de mani√®re uniforme.

Par exemple, le syst√®me de fichiers, les variables d'environnement et le registre sont des syst√®mes de donn√©es tr√®s diff√©rents. Gr√¢ce aux providers, on peut les interroger de la m√™me mani√®re et avec les m√™mes commandes.

![Get-PSProvider](./assets/r15/get-psprovider.png)


Voici les principaux providers

| Nom         | Description |
| ----------- | ----------- |
| FileSystem  | Ce provider procure un acc√®s au syst√®me de fichiers. |
| Registry    | Ce provider permet de manipuler la base de registre. |
| Alias       | Ce provider permet de manipuler les alias PowerShell |
| Variable    | Ce provider permet d'interroger et g√©rer les variables PowerShell |
| Function    | Ce provider permet d'interroger et g√©rer les fonctions PowerShell |
| Environment | Ce provider donne acc√®s aux variables d'environnement de la session en cours |


Les **lecteurs PowerShell** (*PSDrive*) sont des points d'entr√©e vers une ressource g√©r√©e par un *PSProvider*. Par exemple, les lecteurs C: et D: sont des lecteurs contenant un syst√®me de fichiers, accessible via le fournisseur *FileSystem*.

![Get-PSDrive](./assets/r15/get-psdrive.png)

Plusieurs commandes PowerShell adoptent un comportement diff√©rent en fonction du fournisseur duquel le chemin sp√©cifi√© est issu. 

Dans l'exemple ci-dessous, on peut voir que le type d'√©l√©ment retourn√© par `Get-ChildItem` est diff√©rent selon que le lecteur sp√©cifi√© en est un expos√© par le fournisseur `FileSystem` ou par le fournisseur `Environment` (qui contient les variables d'environnement).

![Get-PSDrive](./assets/r15/gci-provider.png)



## Le registre de Windows

Le registre de Windows est une base de donn√©es interne √† Windows qui sert √† **centraliser la configuration** du syst√®me d'exploitation et de ses applications afin d'√©viter l'√©parpillement de fichiers de configuration.

Le registre est un composant fondamental du syst√®me d'exploitation. Windows offre diverses m√©thodes permettant aux applications et aux scripts de lire et d'√©crire des valeurs dans le registre.

L'√©diteur de registre (regedit.exe) est un outil int√©gr√© √† Windows qui permet d'explorer le registre √† l'aide d'une interface graphique, √† l'instar de l'explorateur de fichiers permet d'explorer graphiquement le syst√®me de fichiers.


### Structure du registre

Le registre de Windows est compos√© de deux types d'√©l√©ments: les **cl√©s** (*keys*) et les **valeurs** (*values*).

![](./assets/r15/registre_cles-val.png)


### Cl√©s

Les **cl√©s** sont des conteneurs, un peu comme les r√©pertoires dans un syst√®me de fichiers. Elles peuvent contenir des valeurs ainsi que d'autres cl√©s (qu'un appellera sous-cl√©s, ou *subkeys*). Les premi√®res cl√©s, situ√©es au premier niveau de l'arborescence, sont appel√©s des **cl√©s de ruche** (*hive key*) ou des **cl√©s racine** (*root key*) et ont pour pr√©fixe HKEY_ (un diminutif de *hive key*).

![](./assets/r15/registre_cles.png)


### Valeurs

Les **valeurs** sont des √©l√©ments porteurs de donn√©es utilisables. Ils sont comparables aux fichiers dans un syst√®me de fichiers, mais leur contenu tend √† √™tre beaucoup plus petit et circonscrit √† une propri√©t√© ou √† une configuration unique. 

Chaque valeur de registre est contenue dans une cl√© et poss√®de trois attributs: un **nom**, un **type** et une **donn√©e**.

![](./assets/r15/registre_val.png)

Les donn√©es inscrite dans une cl√© doivent √™tre d'un type pr√©cis. Voici les principaux types de donn√©es admissibles pour une valeur de registre:

| Type | Nom | Description |
| -- | -- | -- |
| REG_SZ | String | Une cha√Æne de caract√®res |
| REG_MULTI_SZ | MultiString | Un tableau de cha√Ænes de caract√®res |
| REG_EXPAND_SZ | ExpandString | Une cha√Æne de caract√®res avec variables d'environnement (ex. %APPDATA%) |
| REG_DWORD | DWord | Une valeur num√©rique de 32 bits (√©quivalent √† [uint32]) |
| REG_QWORD | QWord | Une valeur num√©rique de 64 bits (√©quivalent √† [uint64]) |
| REG_BINARY | Binary | Des donn√©es binaires brutes |


### Fichiers du registre

La base de registre est compos√©e de plusieurs fichiers, appel√©s **ruches** (*hive*). Au d√©marrage de Windows (ou d'une session utilisateur), Voici les principaux fichiers qui sont charg√©s:

| Cl√© | Fichier | Port√©e |
| -- | -- | -- |
| HKEY_LOCAL_MACHINE\SOFTWARE | C:\Windows\System32\config\SOFTWARE | Syst√®me |
| HKEY_LOCAL_MACHINE\SECURITY | C:\Windows\System32\config\SECURITY | Syst√®me |
| HKEY_LOCAL_MACHINE\SYSTEM | C:\Windows\System32\config\SYSTEM | Syst√®me |
| HKEY_LOCAL_MACHINE\SAM | C:\Windows\System32\config\SAM | Syst√®me |
| HKEY_USERS\\.DEFAULT | C:\Windows\System32\config\DEFAULT | Syst√®me |
| HKEY_CURRENT_USER | %UserProfile%\NTUSER.DAT | Utilisateur |


### Principales racines

Dans le registre, il y a deux racines fondamentales. 

- **`HKEY_LOCAL_MACHINE (HKLM)`** rassemble la configuration globale du syst√®me
- **`HKEY_USERS (HKU)`** rassemble la configuration des utilisateurs

Il y a aussi plusieurs racines alias, sorte de raccourcis vers certaines parties des racines fondamentales.

- **`HKEY_CURRENT_USER (HKCU)`** contient la configuration du profil de l'utilisateur courant. Elle est un raccourci vers `HKU\SID_de_l'utilisateur`.
- **`HKEY_CLASSES_ROOT (HKCR)`** contient la configuration des classes de fichiers et de protocoles, issue de la superposition de `HKCU\SOFTWARE\Classes` et `HKLM\SOFTWARE\Classes`
- **`HKEY_CURRENT_CONFIG (HKCC)`** contient de l'information sur le profil mat√©riel du syst√®me. 


#### HKEY_CURRENT_USER (HKCU)

La cl√© racine `HKEY_CURRENT_USER`, ou `HKCU` en abr√©g√©, contient les donn√©es de configuration **propres √† l'utilisateur**. Chaque utilisateur poss√®de sa propre ruche. Ces donn√©es sont comprises dans le fichier `NTUSER`.DAT situ√© dans le profil utilisateur sous `C:\Users\`. 

L'utilisateur n'a pas besoin d'√™tre administrateur local pour √©crire ou modifier des valeurs dans cette ruche, puisque celle-ci appartient √† l'utilisateur.


#### HKEY_LOCAL_MACHINE (HKLM)

La cl√© racine `HKEY_LOCAL_MACHINE`, ou `HKLM` en abr√©g√©, contient les donn√©es de configuration **globales du syst√®me**. Ces configurations sont les m√™mes peu importe l'utilisateur connect√©.

On doit obligatoirement poss√©der des droits d'administration pour modifier les valeurs contenues dans cette ruche.

La plupart des param√®tres propres aux √©l√©ments logiciels (y compris les param√®tres du syst√®me d'exploitation) sont situ√©s dans la cl√© SOFTWARE.

:::tip
De nos jours, Windows est presque toujours install√© dans son √©dition 64 bits. Cependant, certaines applications plus vieilles ont √©t√© compil√©es pour une architecture de processeur 32 bits. Windows 10/11 et Windows Server poss√®dent un sous-syst√®me d'√©mulation permettant d'ex√©cuter des programmes 32 bits. Ce sous-syst√®me s'appelle "WoW64", pour "*Windows-on-Windows 64-bit*". 

Les fichiers des logiciels 32-bits install√©s dans une √©ditions 64-bits de Windows sont situ√©s dans le r√©pertoire `C:\Program Files (x86)\` (r√©f√©renc√© par la variable d'environnement `%ProgramFiles(x86)%`, ou `$env:{ProgramFiles(x86)}` en PowerShell). Leurs param√®tres dans le registre sont situ√©s sous la cl√© `HKLM\SOFTWARE\WOW6432Node\`.
:::

#### HKEY_USERS (HKU)

La cl√© racine `HKEY_USERS` (en abr√©g√© `HKU`) est une des racines fondamentales de Windows et comprend tous les utilisateurs qui ont une session ouverte.

La cl√© `.DEFAULT` repr√©sente le profil utilisateur du compte SYSTEM, et les autres cl√©s sont identifi√©es par le SID de l'utilisateur.

La ruche de l'utilisateur courant est accessible par `HKEY_CURRENT_USER`.

![](./assets/r15/hku.png)


#### HKEY_CLASSES_ROOT (HKCR)

La cl√© racine `HKEY_CLASSES_ROOT` (en abr√©g√© `HKCR`) contient la configuration des types de documents, d'extensions et des protocoles pris en charge par Windows. L'organisation de cette racine est assez complexe, mais essentielle √† Windows puisque c'est l√† qu'est rassembl√©e toute l'information qui permet √† Windows de savoir, par exemple, quelle application d√©marrer si on double-clique sur un fichier portant une extension, quelles sont les options disponibles dans le menu contextuel, etc.

Cette racine est en fait une combinaisaison de deux cl√©s:
- `HKEY_LOCAL_MACHINE\SOFTWARE\Classes` (la configuration syst√®me)
- `HKU\(sid)_CLASSES` (la configuration utilisateur)

Un param√®tre d√©fini dans la configuration utilisateur a pr√©s√©ance sur le m√™me param√®tre d√©fini dans la configuration syst√®me.

:::tip
La partie *Classes* du profil utilisateur n'est pas sauvegard√©e dans `%USERPROFILE%\NTUSER.DAT` comme le reste de sa ruche, elle est dans un fichier diff√©rent: `%LOCALAPPDATA%\Microsoft\Windows\UsrClass.dat`
:::


## Acc√®s au registre avec PowerShell

On peut facilement lire et √©crire des informations dans le registre de Windows via le fournisseur `Registry`.

### Obtenir la liste des sous-cl√©s d'une cl√©

On obtient la liste des sous-cl√© d'une cl√© avec la commande `Get-ChildItem`.

![](./assets/r15/reg_subkey1.png)

Pour voir seulement la liste des cl√©s, sans montrer aussi les valeurs qui y sont contenues, on peut ajouter le *switch* `-Name`.

![](./assets/r15/reg_subkey2.png)

### Tester si une cl√© existe

Pour tester si une cl√© existe, c'est tr√®s simple: il suffit d'utiliser `Test-Path`.

![](./assets/r15/reg_testkey.png)


### Cr√©er une cl√©

Pour cr√©er une nouvelle cl√©, on peut utiliser la commande `New-Item`.

```powershell
New-Item -Path "HKCU:\SOFTWARE\MaNouvelleCl√©"
```

![](./assets/r15/reg_newkey1.png)

Pour que √ßa fonctionne, la cl√© parente doit exister. On peut cependant sp√©cifier le switch `-Force` pour que l'arborescence de cl√© soit automatiquement cr√©√©e.

![](./assets/r15/reg_newkey2.png)

### Effacer une cl√©

Pour effacer une cl√©, il suffit d'utiliser la commande `Remove-Item`.

```powershell
Remove-Item -Path "HKCU:\SOFTWARE\MaNouvelleCl√©"
```

![](./assets/r15/reg_delkey.png)

Si cette cl√© contient des sous-cl√©s, on peut sp√©cifier le switch `-Recurse` pour effacer r√©cursivement toutes les sous-cl√©s.

```powershell
Remove-Item -Path "HKCU:\SOFTWARE\UneCl√©" -Recurse
```



### Obtenir les valeurs dans une cl√©

Pour obtenir toutes les valeurs dans une certaine cl√©, on peut utiliser la commande `Get-ItemProperty`.

![](./assets/r15/reg_val1.png)

Pour obtenir une valeur sp√©cifique, on peut utiliser la commande `Get-ItemPropertyValue` en sp√©cifiant la cl√© comme chemin et le nom de la valeur.

![](./assets/r15/reg_val2.png)

Il existe plusieurs autres mani√®res d'obtenir les donn√©es dans une valeur de registre. Voici quelques autres exemples:

![](./assets/r15/reg_val3.png)

On peut aussi utiliser la m√©thode `.GetValue()` d'une cl√©, comme le montre l'exemple ci-dessous:

![](./assets/r15/reg_val4.png)


### Tester si une valeur existe

Voici une mani√®re de tester si une valeur existe.

![](./assets/r15/reg_testval.png)

### Cr√©er une valeur

Pour cr√©er une valeur dans le registre, on peut utiliser la commande `New-ItemProperty`.

Voici un exemple qui modifie la configuration du bloc-notes de Windows pour que la police de caract√®res soit "Comic Sans MS".

```powershell
$NewRegValSplat = @{
    Path = "HKCU:\SOFTWARE\Microsoft\Notepad\"
    Name = "lfFaceName"
    PropertyType = "String"
    Value = "Comic Sans MS"
}

New-ItemProperty @NewRegValSplat
```


### Modifier une valeur existante

Pour modifier une valeur de registre existante, on peut utiliser la commande `Set-ItemProperty`. La valeur doit d√©j√† exister pour que cette commande fonction

```powershell
$SetRegValSplat = @{
    Path = "HKCU:\SOFTWARE\Microsoft\Notepad\"
    Name = "lfFaceName"
    Value = "Wingdings"
}

New-ItemProperty @SetRegValSplat
```

### Effacer une valeur

Pour effacer une valeur de registre, on peut utiliser la commande `Remove-ItemProperty`.

![](./assets/r15/reg_delval.png)


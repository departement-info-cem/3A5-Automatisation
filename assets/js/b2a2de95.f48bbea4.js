"use strict";(self.webpackChunkdepinfo_template=self.webpackChunkdepinfo_template||[]).push([[97],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>f});var s=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,s)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,s,a=function(e,t){if(null==e)return{};var n,s,a={},i=Object.keys(e);for(s=0;s<i.length;s++)n=i[s],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(s=0;s<i.length;s++)n=i[s],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=s.createContext({}),u=function(e){var t=s.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},c=function(e){var t=u(e.components);return s.createElement(l.Provider,{value:t},e.children)},d="mdxType",p={inlineCode:"code",wrapper:function(e){var t=e.children;return s.createElement(s.Fragment,{},t)}},m=s.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,l=e.parentName,c=o(e,["components","mdxType","originalType","parentName"]),d=u(n),m=a,f=d["".concat(l,".").concat(m)]||d[m]||p[m]||i;return n?s.createElement(f,r(r({ref:t},c),{},{components:n})):s.createElement(f,r({ref:t},c))}));function f(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,r=new Array(i);r[0]=m;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o[d]="string"==typeof e?e:a,r[1]=o;for(var u=2;u<i;u++)r[u]=n[u];return s.createElement.apply(null,r)}return s.createElement.apply(null,n)}m.displayName="MDXCreateElement"},85162:(e,t,n)=>{n.d(t,{Z:()=>r});var s=n(67294),a=n(86010);const i={tabItem:"tabItem_Ymn6"};function r(e){let{children:t,hidden:n,className:r}=e;return s.createElement("div",{role:"tabpanel",className:(0,a.Z)(i.tabItem,r),hidden:n},t)}},74866:(e,t,n)=>{n.d(t,{Z:()=>w});var s=n(87462),a=n(67294),i=n(86010),r=n(12466),o=n(16550),l=n(91980),u=n(67392),c=n(50012);function d(e){return function(e){return a.Children.map(e,(e=>{if(!e||(0,a.isValidElement)(e)&&function(e){const{props:t}=e;return!!t&&"object"==typeof t&&"value"in t}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}(e).map((e=>{let{props:{value:t,label:n,attributes:s,default:a}}=e;return{value:t,label:n,attributes:s,default:a}}))}function p(e){const{values:t,children:n}=e;return(0,a.useMemo)((()=>{const e=t??d(n);return function(e){const t=(0,u.l)(e,((e,t)=>e.value===t.value));if(t.length>0)throw new Error(`Docusaurus error: Duplicate values "${t.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[t,n])}function m(e){let{value:t,tabValues:n}=e;return n.some((e=>e.value===t))}function f(e){let{queryString:t=!1,groupId:n}=e;const s=(0,o.k6)(),i=function(e){let{queryString:t=!1,groupId:n}=e;if("string"==typeof t)return t;if(!1===t)return null;if(!0===t&&!n)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return n??null}({queryString:t,groupId:n});return[(0,l._X)(i),(0,a.useCallback)((e=>{if(!i)return;const t=new URLSearchParams(s.location.search);t.set(i,e),s.replace({...s.location,search:t.toString()})}),[i,s])]}function h(e){const{defaultValue:t,queryString:n=!1,groupId:s}=e,i=p(e),[r,o]=(0,a.useState)((()=>function(e){let{defaultValue:t,tabValues:n}=e;if(0===n.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(t){if(!m({value:t,tabValues:n}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${t}" but none of its children has the corresponding value. Available values are: ${n.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return t}const s=n.find((e=>e.default))??n[0];if(!s)throw new Error("Unexpected error: 0 tabValues");return s.value}({defaultValue:t,tabValues:i}))),[l,u]=f({queryString:n,groupId:s}),[d,h]=function(e){let{groupId:t}=e;const n=function(e){return e?`docusaurus.tab.${e}`:null}(t),[s,i]=(0,c.Nk)(n);return[s,(0,a.useCallback)((e=>{n&&i.set(e)}),[n,i])]}({groupId:s}),v=(()=>{const e=l??d;return m({value:e,tabValues:i})?e:null})();(0,a.useLayoutEffect)((()=>{v&&o(v)}),[v]);return{selectedValue:r,selectValue:(0,a.useCallback)((e=>{if(!m({value:e,tabValues:i}))throw new Error(`Can't select invalid tab value=${e}`);o(e),u(e),h(e)}),[u,h,i]),tabValues:i}}var v=n(72389);const k={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};function g(e){let{className:t,block:n,selectedValue:o,selectValue:l,tabValues:u}=e;const c=[],{blockElementScrollPositionUntilNextRender:d}=(0,r.o5)(),p=e=>{const t=e.currentTarget,n=c.indexOf(t),s=u[n].value;s!==o&&(d(t),l(s))},m=e=>{let t=null;switch(e.key){case"Enter":p(e);break;case"ArrowRight":{const n=c.indexOf(e.currentTarget)+1;t=c[n]??c[0];break}case"ArrowLeft":{const n=c.indexOf(e.currentTarget)-1;t=c[n]??c[c.length-1];break}}t?.focus()};return a.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,i.Z)("tabs",{"tabs--block":n},t)},u.map((e=>{let{value:t,label:n,attributes:r}=e;return a.createElement("li",(0,s.Z)({role:"tab",tabIndex:o===t?0:-1,"aria-selected":o===t,key:t,ref:e=>c.push(e),onKeyDown:m,onClick:p},r,{className:(0,i.Z)("tabs__item",k.tabItem,r?.className,{"tabs__item--active":o===t})}),n??t)})))}function b(e){let{lazy:t,children:n,selectedValue:s}=e;const i=(Array.isArray(n)?n:[n]).filter(Boolean);if(t){const e=i.find((e=>e.props.value===s));return e?(0,a.cloneElement)(e,{className:"margin-top--md"}):null}return a.createElement("div",{className:"margin-top--md"},i.map(((e,t)=>(0,a.cloneElement)(e,{key:t,hidden:e.props.value!==s}))))}function N(e){const t=h(e);return a.createElement("div",{className:(0,i.Z)("tabs-container",k.tabList)},a.createElement(g,(0,s.Z)({},e,t)),a.createElement(b,(0,s.Z)({},e,t)))}function w(e){const t=(0,v.Z)();return a.createElement(N,(0,s.Z)({key:String(t)},e))}},81124:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>l,default:()=>f,frontMatter:()=>o,metadata:()=>u,toc:()=>d});var s=n(87462),a=(n(67294),n(3905)),i=n(74866),r=n(85162);const o={},l="Rencontre 19 - Administration \xe0 distance",u={unversionedId:"cours/r19",id:"cours/r19",title:"Rencontre 19 - Administration \xe0 distance",description:"1. WMI \xe0 distance",source:"@site/docs/cours/r19.md",sourceDirName:"cours",slug:"/cours/r19",permalink:"/3A5-Automatisation/cours/r19",draft:!1,tags:[],version:"current",frontMatter:{},sidebar:"docs",previous:{title:"Rencontre 18 - Laboratoire AD",permalink:"/3A5-Automatisation/cours/r18"},next:{title:"Rencontre 21 - Travail sur le TP2",permalink:"/3A5-Automatisation/cours/r21"}},c={},d=[{value:"WMI \xe0 distance",id:"wmi-\xe0-distance",level:2},{value:"Pr\xe9paration",id:"pr\xe9paration",level:3},{value:"Pare-feu",id:"pare-feu",level:4},{value:"Get-Credential",id:"get-credential",level:3},{value:"Objets PSCredential",id:"objets-pscredential",level:3},{value:"RPC et WinRM",id:"rpc-et-winrm",level:3},{value:"Activation de WinRM sur un serveur",id:"activation-de-winrm-sur-un-serveur",level:3},{value:"Le pare-feu",id:"le-pare-feu",level:4},{value:"Chiffrement",id:"chiffrement",level:4},{value:"Sessions PowerShell \xe0 distance",id:"sessions-powershell-\xe0-distance",level:2},{value:"Authentification",id:"authentification",level:3},{value:"Cr\xe9er des sessions PowerShell",id:"cr\xe9er-des-sessions-powershell",level:3},{value:"Terminer une session",id:"terminer-une-session",level:4},{value:"Terminer toutes les sessions ouvertes",id:"terminer-toutes-les-sessions-ouvertes",level:4},{value:"Invoke-Command",id:"invoke-command",level:3},{value:"Ex\xe9cuter un bloc de commandes",id:"ex\xe9cuter-un-bloc-de-commandes",level:4},{value:"Ex\xe9cuter un script",id:"ex\xe9cuter-un-script",level:4},{value:"Sp\xe9cifier les noms de machines au lieu des sessions",id:"sp\xe9cifier-les-noms-de-machines-au-lieu-des-sessions",level:4},{value:"PSRemoting et pipeline",id:"psremoting-et-pipeline",level:3},{value:"Plusieurs sessions en m\xeame temps",id:"plusieurs-sessions-en-m\xeame-temps",level:3},{value:"Copie de fichiers \xe0 travers une session",id:"copie-de-fichiers-\xe0-travers-une-session",level:3},{value:"De la machine locale vers la machine distante",id:"de-la-machine-locale-vers-la-machine-distante",level:4},{value:"De la machine distante vers la machine locale",id:"de-la-machine-distante-vers-la-machine-locale",level:4}],p={toc:d},m="wrapper";function f(e){let{components:t,...o}=e;return(0,a.kt)(m,(0,s.Z)({},p,o,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"rencontre-19---administration-\xe0-distance"},"Rencontre 19 - Administration \xe0 distance"),(0,a.kt)("admonition",{title:"R\xe9sum\xe9 de la s\xe9ance",type:"note"},(0,a.kt)(i.Z,{mdxType:"Tabs"},(0,a.kt)(r.Z,{value:"deroulement",label:"\ud83d\udc68\u200d\ud83c\udfeb D\xe9roulement du cours",mdxType:"TabItem"},(0,a.kt)("ol",{parentName:"admonition"},(0,a.kt)("li",{parentName:"ol"},"WMI \xe0 distance"),(0,a.kt)("li",{parentName:"ol"},"Protocole WinRM"),(0,a.kt)("li",{parentName:"ol"},"Sessions PowerShell \xe0 distance"))),(0,a.kt)(r.Z,{value:"exercices",label:"\ud83d\udcbb Exercices \xe0 compl\xe9ter",mdxType:"TabItem"},(0,a.kt)("ul",{parentName:"admonition"},(0,a.kt)("li",{parentName:"ul"},"Laboratoire 19 sur OneNote"))),(0,a.kt)(r.Z,{value:"ressources",label:"\ud83d\udcda Ressources \xe0 consulter",mdxType:"TabItem"},(0,a.kt)("p",{parentName:"admonition"},"La pr\xe9sentation PowerPoint est sur le Teams du cours, sous le canal G\xe9n\xe9ral > Fichiers > Supports de cours.")))),(0,a.kt)("h2",{id:"wmi-\xe0-distance"},"WMI \xe0 distance"),(0,a.kt)("p",null,"On peut lancer des requ\xeates WMI \xe0 distance sur une machine du r\xe9seau, en sp\xe9cifiant le param\xe8tre ",(0,a.kt)("inlineCode",{parentName:"p"},"-ComputerName")," de la commande ",(0,a.kt)("inlineCode",{parentName:"p"},"Get-WmiObject"),"."),(0,a.kt)("p",null,"Pour que ce soit possible, il faut s'assurer de plusieurs choses:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"La machine distante est joignable sur le r\xe9seau"),(0,a.kt)("li",{parentName:"ul"},"Le service WMI (winmgmt) est actif sur la machine distante (c'est le cas par d\xe9faut)"),(0,a.kt)("li",{parentName:"ul"},"Nous avons des droits d'administration sur la machine distante"),(0,a.kt)("li",{parentName:"ul"},"Le pare-feu laisse passer le trafic WMI")),(0,a.kt)("p",null,"Lorsque les machines sont membres du domaine et que nous sommes authentifi\xe9s avec un compte qui poss\xe8de des droits d'administration sur les machines (c'est le cas du compte d'admin du domaine), il suffit de pr\xe9ciser le nom de la machine et les requ\xeates se font \xe0 travers le r\xe9seau."),(0,a.kt)("p",null,(0,a.kt)("img",{src:n(45611).Z,width:"867",height:"238"})),(0,a.kt)("p",null,"Le param\xe8tre ",(0,a.kt)("inlineCode",{parentName:"p"},"-ComputerName")," est de type ",(0,a.kt)("inlineCode",{parentName:"p"},"string[]"),", donc il est possible de lui donner plusieurs ordinateurs, ou encore de lui passer un tableau de strings."),(0,a.kt)("p",null,(0,a.kt)("img",{src:n(51542).Z,width:"867",height:"178"})),(0,a.kt)("p",null,(0,a.kt)("img",{src:n(54942).Z,width:"867",height:"188"})),(0,a.kt)("admonition",{type:"tip"},(0,a.kt)("p",{parentName:"admonition"},"M\xeame si le nom du param\xe8tre sugg\xe8re qu'on doive passer un nom d'ordinateur, on peut aussi passer l'adresse IP num\xe9rique de l'ordinateur ou encore le nom DNS complet (FQDN). Dans un environnement de domaine simple, on tend souvent \xe0 n'indiquer que le nom de l'ordinateur, puisque les machines membres du domaine vont automatiquement appliquer le suffixe DNS de leur domaine. "),(0,a.kt)("p",{parentName:"admonition"},"Concernant les r\xe9solutions de nom court: Par exemple, si on tente de r\xe9soudre le serveur ",(0,a.kt)("em",{parentName:"p"},"SRV01")," sur une machine client membre du domaine ",(0,a.kt)("em",{parentName:"p"},"auto.cemti.ca"),", la r\xe9solution r\xe9elle se fera sur ",(0,a.kt)("em",{parentName:"p"},"SRV01.auto.cemti.ca"),". ")),(0,a.kt)("h3",{id:"pr\xe9paration"},"Pr\xe9paration"),(0,a.kt)("p",null,"Dans plusieurs cas, l'administration \xe0 distance de Windows est d\xe9sactiv\xe9e pour des raisons de s\xe9curit\xe9. On l'active au besoin. Dans plusieurs entreprises, o\xf9 la gestion des ordinateurs \xe0 distance est importante, ces configurations sont automatis\xe9es."),(0,a.kt)("h4",{id:"pare-feu"},"Pare-feu"),(0,a.kt)("p",null,"WMI repose sur DCOM et RPC, deux protocoles d'administration \xe0 distance int\xe9gr\xe9s \xe0 Windows. Ceux-ci sont actifs par d\xe9faut sous Windows, mais le pare-feu bloque le trafic provenant de l'ext\xe9rieur. Pour permettre de passer des requ\xeates WMI \xe0 une machine distante, il faut ouvrir le pare-feu des machine sur lesquelles vous voulez vous connecter."),(0,a.kt)("p",null,'Pour ce faire, d\xe9marrez la console avanc\xe9e du pare-feu de Windows (wf.msc) et activez l\'ensemble de r\xe8gles du groupe "Windows Management Instrumentation".'),(0,a.kt)("p",null,(0,a.kt)("img",{src:n(64521).Z,width:"571",height:"140"})),(0,a.kt)("p",null,(0,a.kt)("img",{src:n(65811).Z,width:"738",height:"395"})),(0,a.kt)("p",null,"Vous pouvez maintenant tester la connexion en sp\xe9cifiant les param\xe8tres ",(0,a.kt)("inlineCode",{parentName:"p"},"ComputerName")," et ",(0,a.kt)("inlineCode",{parentName:"p"},"Credential")," (si n\xe9cessaire)."),(0,a.kt)("p",null,(0,a.kt)("img",{src:n(24778).Z,width:"869",height:"215"})),(0,a.kt)("h3",{id:"get-credential"},"Get-Credential"),(0,a.kt)("p",null,"Pour administrer une machine \xe0 distance, il faut minimalement avoir les privil\xe8ges pour l'administrer."),(0,a.kt)("p",null,"Dans un domaine Active Directory, l'authentification est g\xe9n\xe9ralement int\xe9gr\xe9e. Lorsque vous ouvrez une session sur votre machine avec votre compte AD, c'est ce m\xeame compte qui sera automatiquement pass\xe9 \xe0 la machine distante que vous tentez d'administrer. Cela simplifie beaucoup les choses."),(0,a.kt)("p",null,"Lorsqu'on veut poser une action sur un serveur distant avec un compte diff\xe9rent de celui dont on s'est servi pour s'authentifier \xe0 notre machine, une mani\xe8re de proc\xe9der est par l'emploi de la commande ",(0,a.kt)("inlineCode",{parentName:"p"},"Get-Credential"),"."),(0,a.kt)("p",null,(0,a.kt)("img",{src:n(44279).Z,width:"708",height:"382"})),(0,a.kt)("p",null,"L'objet retourn\xe9 est de type ",(0,a.kt)("inlineCode",{parentName:"p"},"PSCredential")," et est le type d'objet \xe0 passer lorsqu'une commande poss\xe8de un param\xe8tre ",(0,a.kt)("inlineCode",{parentName:"p"},"Credential")),(0,a.kt)("p",null,(0,a.kt)("img",{src:n(93532).Z,width:"869",height:"270"})),(0,a.kt)("admonition",{type:"tip"},(0,a.kt)("p",{parentName:"admonition"},"On ne devrait jamais utiliser ",(0,a.kt)("inlineCode",{parentName:"p"},"Get-Credential")," dans un script ou une fonction, car cela force une action de l'utilisateur m\xeame s'il poss\xe8de d\xe9j\xe0 des droits suffisants. \xc7a l'obligerait \xe0 se r\xe9authentifier \xe0 chaque lancement du script. On ne devrait utiliser ",(0,a.kt)("inlineCode",{parentName:"p"},"Get-Credential")," que lorsque l'utilisateur doit utiliser un compte diff\xe9rent que celui avec lequel il op\xe8re sa session PowerShell."),(0,a.kt)("p",{parentName:"admonition"},"En fait, on devrait plut\xf4t cr\xe9er un param\xe8tre ",(0,a.kt)("inlineCode",{parentName:"p"},"-Credential")," non-obligatoire dont la valeur par d\xe9faut est un jeton vide."),(0,a.kt)("pre",{parentName:"admonition"},(0,a.kt)("code",{parentName:"pre",className:"language-powershell"},"[CmdletBinding()]\nParam(\n    [System.Management.Automation.PSCredential]\n    $Credential = [System.Management.Automation.PSCredential]::Empty\n)\n")),(0,a.kt)("p",{parentName:"admonition"},"On passe alors ",(0,a.kt)("inlineCode",{parentName:"p"},"$Credential")," dans les param\xe8tres ",(0,a.kt)("inlineCode",{parentName:"p"},"-Credential")," des commandes qui sont appel\xe9es. Si le param\xe8tre n'a pas \xe9t\xe9 sp\xe9cifi\xe9 au lancement du script, le jeton est vide, et cela indique \xe0 la commande d'ex\xe9cuter la commande au nom de l'utilisateur qui l'appelle."),(0,a.kt)("p",{parentName:"admonition"},(0,a.kt)("inlineCode",{parentName:"p"},"Get-Credential")," devrait seulement \xeatre utilis\xe9 au moment d'appeler le script, au besoin."),(0,a.kt)("pre",{parentName:"admonition"},(0,a.kt)("code",{parentName:"pre",className:"language-powershell"},".\\MonScript.ps1 -Credential (Get-Credential)\n"))),(0,a.kt)("h3",{id:"objets-pscredential"},"Objets PSCredential"),(0,a.kt)("p",null,"Creusons un peu dans l'objet ",(0,a.kt)("inlineCode",{parentName:"p"},"PSCredential"),"."),(0,a.kt)("p",null,"Cet objet poss\xe8de deux propri\xe9t\xe9s: ",(0,a.kt)("inlineCode",{parentName:"p"},"UserName")," et ",(0,a.kt)("inlineCode",{parentName:"p"},"Password"),"."),(0,a.kt)("p",null,(0,a.kt)("img",{src:n(64525).Z,width:"989",height:"349"})),(0,a.kt)("p",null,"Pourtant, le mot de passe n'est pas visible. Il s'agit d'un objet ",(0,a.kt)("inlineCode",{parentName:"p"},"SecureString"),"."),(0,a.kt)("p",null,(0,a.kt)("img",{src:n(80470).Z,width:"989",height:"212"})),(0,a.kt)("p",null,"Les objets ",(0,a.kt)("inlineCode",{parentName:"p"},"SecureString")," servent principalement \xe0 stocker des mots de passe de mani\xe8re s\xe9curitaire. On peut leur affecter une cha\xeene de caract\xe8res, mais on ne peut pas la lire. Le mot de passe contenu dans cet objet est chiffr\xe9."),(0,a.kt)("p",null,(0,a.kt)("img",{src:n(33545).Z,width:"989",height:"506"})),(0,a.kt)("h3",{id:"rpc-et-winrm"},"RPC et WinRM"),(0,a.kt)("p",null,"Le syst\xe8me d'exploitation Windows offre plusieurs options pour permettre aux administrateurs syst\xe8mes de les administrer \xe0 distance, \xe0 travers le r\xe9seau."),(0,a.kt)("p",null,"Nous avons vu pr\xe9c\xe9demment comment les requ\xeates WMI, \xe0 l'aide de la commande ",(0,a.kt)("inlineCode",{parentName:"p"},"Get-WmiObject"),", peuvent \xeatre pass\xe9es \xe0 des h\xf4tes distants. C'est possible au moyen du protocole RPC (Remote Procedure Call), un protocole datant des ann\xe9es 80. Microsoft a utilis\xe9 RPC dans ses outils de gestion d\xe8s les d\xe9buts de Windows NT, dans les ann\xe9es 90, et est encore aujourd'hui largement utilis\xe9. C'est ce protocole qui permet l'administration \xe0 distance avec WMI et les consoles de gestion MMC (comme Computer Management)."),(0,a.kt)("p",null,"RPC n'a pas \xe9t\xe9 con\xe7u pour la s\xe9curit\xe9, qui n'\xe9tait pas un grand enjeu \xe0 l'\xe9poque. Microsoft a fait \xe9voluer le protocole, lui greffant des routines de s\xe9curit\xe9, mais \xe7a a donn\xe9 un protocole tr\xe8s complexe et fragile. La nature du protocole oblige, entre autres, \xe0 ouvrir un tr\xe8s grand nombre de ports entrants (tous les ports de 1024-65535, \xe9ventuellement r\xe9duit \xe0 49152-65535), ce qui \xe9largit la surface d'exposition \xe0 des menaces ext\xe9rieures. Aussi, le trafic RPC n'est g\xe9n\xe9ralement pas chiffr\xe9 (\xe0 l'exception des credentials)."),(0,a.kt)("p",null,"Microsoft a donc d\xe9velopp\xe9 un nouveau protocole d'administration \xe0 distance pour Windows, avec cette fois-ci la s\xe9curit\xe9 en t\xeate. Ce protocole, c'est WinRM. Il est bas\xe9 sur HTTP/HTTPS, comme pour le Web."),(0,a.kt)("h3",{id:"activation-de-winrm-sur-un-serveur"},"Activation de WinRM sur un serveur"),(0,a.kt)("p",null,"Pour activer WinRM sur une machine (la machine qui va recevoir la connexion), on peut utiliser la commande suivante, dans une console powershell \xe9lev\xe9e (en tant qu'administrateur)"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-powershell"},"Enable-PSRemoting -Force\n")),(0,a.kt)("p",null,"Si WinRM est d\xe9j\xe0 activ\xe9, la commande vous le dira. Sinon, la commande se chargera d'activer WinRM pour vous, incluant le service et le pare-feu."),(0,a.kt)("p",null,"On peut \xe9galement utiliser la commande winrm quickconfig pour arriver au m\xeame r\xe9sultat."),(0,a.kt)("admonition",{type:"tip"},(0,a.kt)("p",{parentName:"admonition"},"Si votre serveur n'est pas dans un domaine, on peut activer WinRM mais la proc\xe9dure est diff\xe9rente."),(0,a.kt)("p",{parentName:"admonition"},"Comme le profil de connexion n'est pas celle d'un domaine, Windows le consid\xe8re moins s\xe9curitaire. Si votre serveur est connect\xe9 dans un environnement que vous consid\xe9rez s\xe9curitaire (un r\xe9seau local d'entreprise par exemple), vous pouvez demander de sauter la v\xe9rification."),(0,a.kt)("pre",{parentName:"admonition"},(0,a.kt)("code",{parentName:"pre",className:"language-powershell"},"Enable-PSRemoting -Force -SkipNetworkProfileCheck\n")),(0,a.kt)("p",{parentName:"admonition"},"Aussi, il faut pr\xe9ciser la liste des machines de confiance. Lorsqu'on est dans un domaine, toutes les machines membres du domaine sont dignes de confiance. Lorsqu'on n'est pas dans un domaine, on doit les d\xe9finir."),(0,a.kt)("pre",{parentName:"admonition"},(0,a.kt)("code",{parentName:"pre",className:"language-powershell"},'Set-Item WSMAN:\\localhost\\Client\\TrustedHosts -Value "192.168.123.45" -Force\n')),(0,a.kt)("p",{parentName:"admonition"},"Si vous voulez accepter la connexion de n'importe quelle machine du r\xe9seau, vous pouvez mettre * comme valeur. Mais sachez que ce n'est pas une bonne pratique de s\xe9curit\xe9."),(0,a.kt)("p",{parentName:"admonition"},"Ensuite, red\xe9marrez le service WinRM pour que les changements soient pris en compte."),(0,a.kt)("pre",{parentName:"admonition"},(0,a.kt)("code",{parentName:"pre",className:"language-powershell"},"Restart-Service WinRM\n"))),(0,a.kt)("h4",{id:"le-pare-feu"},"Le pare-feu"),(0,a.kt)("p",null,"Normalement, la r\xe8gle de pare-feu est cr\xe9\xe9e automatiquement. Vous pouvez vous en assurer dans la console du pare-feu (wf.msc)."),(0,a.kt)("p",null,(0,a.kt)("img",{src:n(43259).Z,width:"810",height:"281"})),(0,a.kt)("h4",{id:"chiffrement"},"Chiffrement"),(0,a.kt)("p",null,"Une bonne pratique, lorsqu'on active WinRM, est de permettre le chiffrement du trafic. Par d\xe9faut, c'est HTTP qui est utilis\xe9 et pas HTTPS. Pour permettre le chiffrement du trafic, tout comme avec HTTPS pour le Web, on a besoin d'un certificat SSL. On n'entrera pas dans ces d\xe9tails dans le cadre de ce cours, mais si \xe7a vous int\xe9resse, consultez ce guide: ",(0,a.kt)("a",{parentName:"p",href:"https://4sysops.com/archives/powershell-remoting-over-https-with-a-self-signed-ssl-certificate/"},"https://4sysops.com/archives/powershell-remoting-over-https-with-a-self-signed-ssl-certificate/"),"."),(0,a.kt)("h2",{id:"sessions-powershell-\xe0-distance"},"Sessions PowerShell \xe0 distance"),(0,a.kt)("p",null,"Une fois que WinRM a \xe9t\xe9 activ\xe9 sur le serveur, vous pouvez maintenant vous y ouvrir une session PowerShell distante. Pour ce faire, utilisez les commandes dont le nom est PSSession."),(0,a.kt)("p",null,(0,a.kt)("img",{src:n(6290).Z,width:"510",height:"360"})),(0,a.kt)("p",null,"Pour acc\xe9der \xe0 la ligne de commande \xe0 distance, la commande \xe0 utiliser est ",(0,a.kt)("inlineCode",{parentName:"p"},"Enter-PSSession"),"."),(0,a.kt)("p",null,(0,a.kt)("img",{src:n(7167).Z,width:"621",height:"109"})),(0,a.kt)("p",null,"Une fois dans la session distante, on voit le nom du serveur dans l'invite. Toutes les commandes qu'on tape ici seront faites comme si nous \xe9tions physiquement sur le serveur."),(0,a.kt)("p",null,(0,a.kt)("img",{src:n(56957).Z,width:"681",height:"233"})),(0,a.kt)("p",null,"Pour quitter la session, vous pouvez utiliser la commande ",(0,a.kt)("inlineCode",{parentName:"p"},"Exit-PSSession"),"."),(0,a.kt)("p",null,(0,a.kt)("img",{src:n(53991).Z,width:"654",height:"118"})),(0,a.kt)("h3",{id:"authentification"},"Authentification"),(0,a.kt)("p",null,"Dans un environnement Active Directory, on se connecte au serveur distant en utilisant par d\xe9faut l'identit\xe9 de l'utilisateur pr\xe9sentement logg\xe9. On peut utiliser le param\xe8tre ",(0,a.kt)("inlineCode",{parentName:"p"},"-Credential")," pour sp\xe9cifier un utilisateur diff\xe9rent."),(0,a.kt)("p",null,"En entreprise, il n'est pas rare de recourir \xe0 cette fa\xe7on de faire. Les utilisateurs (m\xeame les admins) utilisent un compte r\xe9gulier, sans droits d'administration, pour travailler sur leur poste de travail. Ils ont un deuxi\xe8me compte, qu'ils utilisent pour se connecter \xe0 des sessions distantes, et c'est ce compte qui poss\xe8de les droits d'administration."),(0,a.kt)("p",null,"Dans cet exemple, l'utilisateur du syst\xe8me est logg\xe9 avec le compte alice, qui n'a aucun droit d'administration. Lorsqu'on tente de se connecter sur le serveur, l'acc\xe8s est refus\xe9."),(0,a.kt)("p",null,(0,a.kt)("img",{src:n(84420).Z,width:"987",height:"335"})),(0,a.kt)("p",null,"Pour se connecter en tant qu'un utilisateur qui poss\xe8de des droits sur ce syst\xe8me, il faut sp\xe9cifier les credentials. On les obtient avec ",(0,a.kt)("inlineCode",{parentName:"p"},"Get-Credential"),"."),(0,a.kt)("p",null,(0,a.kt)("img",{src:n(74879).Z,width:"543",height:"434"})),(0,a.kt)("p",null,"Et on passe cet objet dans le param\xe8tre -Credential."),(0,a.kt)("p",null,(0,a.kt)("img",{src:n(7676).Z,width:"708",height:"206"})),(0,a.kt)("h3",{id:"cr\xe9er-des-sessions-powershell"},"Cr\xe9er des sessions PowerShell"),(0,a.kt)("p",null,"Les sessions interactives, c'est bien, mais on doit faire toutes nos commandes dans l'ordinateur distant. Si on a un script \xe0 ex\xe9cuter, il faut d'abord le transf\xe9rer sur l'ordinateur distant, ce qui n'est pas pratique."),(0,a.kt)("p",null,"On peut ouvrir des sessions PowerShell \xe0 distance, non pas pour acc\xe9der \xe0 la console, mais pour y lancer des commandes."),(0,a.kt)("p",null,"Cr\xe9er la session"),(0,a.kt)("p",null,"On cr\xe9er une nouvelle session avec la commande ",(0,a.kt)("inlineCode",{parentName:"p"},"New-PSSession"),". Celle-ci sera ouverte et portera un num\xe9ro d'identification."),(0,a.kt)("p",null,(0,a.kt)("img",{src:n(31063).Z,width:"912",height:"195"})),(0,a.kt)("p",null,"Obtenir les sessions existantes"),(0,a.kt)("p",null,"On peut obtenir l'\xe9tat des sessions en cours avec ",(0,a.kt)("inlineCode",{parentName:"p"},"Get-PSSession"),"."),(0,a.kt)("p",null,(0,a.kt)("img",{src:n(37109).Z,width:"856",height:"209"})),(0,a.kt)("p",null,"Affecter une session \xe0 une variable"),(0,a.kt)("p",null,"Pour obtenir une session sp\xe9cifique et la mettre dans une variable, on peut l'affecter avec ",(0,a.kt)("inlineCode",{parentName:"p"},"Get-PSSession")," si la session est d\xe9j\xe0 ouverte, ou encore, l'affecter directement avec ",(0,a.kt)("inlineCode",{parentName:"p"},"New-PSSession"),"."),(0,a.kt)("p",null,(0,a.kt)("img",{src:n(81016).Z,width:"860",height:"219"})),(0,a.kt)("p",null,(0,a.kt)("img",{src:n(72526).Z,width:"893",height:"333"})),(0,a.kt)("h4",{id:"terminer-une-session"},"Terminer une session"),(0,a.kt)("p",null,(0,a.kt)("img",{src:n(7135).Z,width:"631",height:"142"})),(0,a.kt)("h4",{id:"terminer-toutes-les-sessions-ouvertes"},"Terminer toutes les sessions ouvertes"),(0,a.kt)("p",null,(0,a.kt)("img",{src:n(3064).Z,width:"582",height:"135"})),(0,a.kt)("h3",{id:"invoke-command"},"Invoke-Command"),(0,a.kt)("p",null,"La commande Invoke-Command ex\xe9cute une commande \xe0 distance. Elle est \xe9quivalente \xe0 appeler powershell.exe sur la machine distante."),(0,a.kt)("p",null,"On peut l'utiliser de deux mani\xe8res."),(0,a.kt)("h4",{id:"ex\xe9cuter-un-bloc-de-commandes"},"Ex\xe9cuter un bloc de commandes"),(0,a.kt)("p",null,"Le bloc de commandes se d\xe9finit avec le param\xe8tre ",(0,a.kt)("inlineCode",{parentName:"p"},"-ScriptBlock"),", entre accolades. C'est pratique pour lancer une commande simple sur les machines distantes."),(0,a.kt)("p",null,(0,a.kt)("img",{src:n(90909).Z,width:"864",height:"220"})),(0,a.kt)("admonition",{type:"caution"},(0,a.kt)("p",{parentName:"admonition"},"Une session PSSession \xe0 distance correspond \xe0 une session PowerShell ouverte sur une autre machine. Par cons\xe9quent, elle est distincte de la session locale. Par exemple, une variable qu'on d\xe9finit dans la session locale ne sera pas accessible sur la session distante."),(0,a.kt)("pre",{parentName:"admonition"},(0,a.kt)("code",{parentName:"pre",className:"language-powershell"},'$NouveauDossier = "C:\\MonDossier"\n$Session = New-PSSession -ComputerName "SRV01"\n\nInvoke-Command -Session $Session -ScriptBlock { \n    New-Item -Path $NouveauDossier -ItemType Directory  # Ne fonctionnera pas!\n}\n')),(0,a.kt)("p",{parentName:"admonition"},"L'exemple pr\xe9c\xe9dent ne fonctionnera pas, puisque la variable ",(0,a.kt)("inlineCode",{parentName:"p"},"$NouveauDossier")," n'a jamais \xe9t\xe9 cr\xe9\xe9e dans la session distante. Elle n'existe que dans la session locale."),(0,a.kt)("p",{parentName:"admonition"},"Pour pouvoir r\xe9cup\xe9rer une variable locale dans un bloc de code \xe0 envoyer \xe0 une machine distante, il faut utiliser le pr\xe9fixe ",(0,a.kt)("inlineCode",{parentName:"p"},"$using:")," avant le nom de la variable."),(0,a.kt)("pre",{parentName:"admonition"},(0,a.kt)("code",{parentName:"pre",className:"language-powershell"},'$NouveauDossier = "C:\\MonDossier"\n$Session = New-PSSession -ComputerName "SRV01"\n\nInvoke-Command -Session $Session -ScriptBlock { \n    New-Item -Path $using:NouveauDossier -ItemType Directory\n}\n')),(0,a.kt)("p",{parentName:"admonition"},"On peut aussi effectuer un ",(0,a.kt)("em",{parentName:"p"},"splatting")," avec un hashtable d\xe9fini localement dans une commande distante avec le pr\xe9fixe ",(0,a.kt)("inlineCode",{parentName:"p"},"@using:"),", de la m\xeame mani\xe8re."),(0,a.kt)("pre",{parentName:"admonition"},(0,a.kt)("code",{parentName:"pre",className:"language-powershell"},'$NouveauDossierSplat = @{\n    Path = "C:\\MonDossier"\n    ItemType = "Directory"\n}\n$Session = New-PSSession -ComputerName "SRV01"\n\nInvoke-Command -Session $Session -ScriptBlock { \n    New-Item @using:NouveauDossierSplat\n}\n'))),(0,a.kt)("h4",{id:"ex\xe9cuter-un-script"},"Ex\xe9cuter un script"),(0,a.kt)("p",null,"Lorsqu'on a un plus grand nombre de commandes \xe0 lancer sur la machine distante, on peut appeler un script."),(0,a.kt)("p",null,"Dans cet exemple, on cr\xe9e un script tout simple compos\xe9 seulement de la commande ",(0,a.kt)("inlineCode",{parentName:"p"},"Get-Process"),", mais \xe7a pourrait \xeatre un script beaucoup plus complexe. Ce script sera lanc\xe9 dans la session distante."),(0,a.kt)("p",null,(0,a.kt)("img",{src:n(69741).Z,width:"859",height:"274"})),(0,a.kt)("h4",{id:"sp\xe9cifier-les-noms-de-machines-au-lieu-des-sessions"},"Sp\xe9cifier les noms de machines au lieu des sessions"),(0,a.kt)("p",null,"On peut aussi cr\xe9er les sessions automatiquement, en sp\xe9cifiant les noms de machines plut\xf4t que des sessions, mais si vous avez plusieurs commandes \xe0 lancer, il sera plus pratique de r\xe9utiliser la m\xeame session pour chacune des commandes au lieu de les r\xe9initier \xe0 chaque fois."),(0,a.kt)("p",null,(0,a.kt)("img",{src:n(89678).Z,width:"918",height:"208"})),(0,a.kt)("h3",{id:"psremoting-et-pipeline"},"PSRemoting et pipeline"),(0,a.kt)("p",null,"Comme c'est une session PowerShell, ce qui sort de la commande distante, c'est un objet. Et cet objet sort sur le pipeline local du client. Autrement dit, quand la commande est lanc\xe9e \xe0 distance, ce qu'elle laisse dans le pipeline revient \xe0 l'appelant, et nous pouvons manipuler cet objet \xe0 notre guise."),(0,a.kt)("p",null,(0,a.kt)("img",{src:n(17953).Z,width:"987",height:"294"})),(0,a.kt)("p",null,"On peut aussi affecter cet objet dans une variable."),(0,a.kt)("p",null,(0,a.kt)("img",{src:n(94728).Z,width:"987",height:"310"})),(0,a.kt)("h3",{id:"plusieurs-sessions-en-m\xeame-temps"},"Plusieurs sessions en m\xeame temps"),(0,a.kt)("p",null,"On peut lancer une commande sur plusieurs sessions d'un coup. "),(0,a.kt)("p",null,(0,a.kt)("img",{src:n(77747).Z,width:"987",height:"438"})),(0,a.kt)("h3",{id:"copie-de-fichiers-\xe0-travers-une-session"},"Copie de fichiers \xe0 travers une session"),(0,a.kt)("p",null,"Il est possible de copier un fichier \xe0 travers une session PSRemoting \xe0 l'aide de la commande ",(0,a.kt)("inlineCode",{parentName:"p"},"Copy-Item"),"."),(0,a.kt)("h4",{id:"de-la-machine-locale-vers-la-machine-distante"},"De la machine locale vers la machine distante"),(0,a.kt)("p",null,"Si on sp\xe9cifie le param\xe8tre ",(0,a.kt)("inlineCode",{parentName:"p"},"-ToSession"),", on envoie le fichier vers la machine cible. Le param\xe8tre -Path repr\xe9sente donc le chemin sur la machine locale, et le param\xe8tre -Destination repr\xe9sente le chemin sur la machine distante."),(0,a.kt)("p",null,(0,a.kt)("img",{src:n(99860).Z,width:"900",height:"135"})),(0,a.kt)("h4",{id:"de-la-machine-distante-vers-la-machine-locale"},"De la machine distante vers la machine locale"),(0,a.kt)("p",null,"\xc0 l'inverse, si on sp\xe9cifie le param\xe8tre ",(0,a.kt)("inlineCode",{parentName:"p"},"-FromSession"),", alors on tire le fichier de l'ordinateur distant vers l'ordinateur local. Le param\xe8tre ",(0,a.kt)("inlineCode",{parentName:"p"},"-Path")," repr\xe9sente alors le chemin sur la machine distante, et le param\xe8tre ",(0,a.kt)("inlineCode",{parentName:"p"},"-Destination"),", celui sur la machine locale."),(0,a.kt)("p",null,(0,a.kt)("img",{src:n(46212).Z,width:"900",height:"135"})))}f.isMDXComponent=!0},44279:(e,t,n)=>{n.d(t,{Z:()=>s});const s=n.p+"assets/images/pscredential_01-c4a520ec11f77d9861d756e87cddb1cb.png"},93532:(e,t,n)=>{n.d(t,{Z:()=>s});const s=n.p+"assets/images/pscredential_02-730ca80f852002f9541b400d4f798644.png"},64525:(e,t,n)=>{n.d(t,{Z:()=>s});const s=n.p+"assets/images/pscredential_04-9c34a7eda707e5883b007a7229fb8aa3.png"},80470:(e,t,n)=>{n.d(t,{Z:()=>s});const s=n.p+"assets/images/pscredential_05-f0ba38769a6f82c5321a282d304ec67c.png"},33545:(e,t,n)=>{n.d(t,{Z:()=>s});const s=n.p+"assets/images/pscredential_06-47c32e118e7b71803836bb20352a425e.png"},6290:(e,t,n)=>{n.d(t,{Z:()=>s});const s=n.p+"assets/images/psremoting_01-79f4fd51a3f0c7c8416b8e2543631aec.png"},7167:(e,t,n)=>{n.d(t,{Z:()=>s});const s=n.p+"assets/images/psremoting_02-0baf0ac22364e937d2275df43483afe3.png"},56957:(e,t,n)=>{n.d(t,{Z:()=>s});const s=n.p+"assets/images/psremoting_03-f8e9936d6baadfaac6bc9d2bb9e19637.png"},53991:(e,t,n)=>{n.d(t,{Z:()=>s});const s=n.p+"assets/images/psremoting_04-4647b1f82529f6ab1ea2ef7603e18bda.png"},31063:(e,t,n)=>{n.d(t,{Z:()=>s});const s=n.p+"assets/images/psremoting_05-389e1e20e6aeb3f4af0c6965e1535693.png"},37109:(e,t,n)=>{n.d(t,{Z:()=>s});const s=n.p+"assets/images/psremoting_06-b27c8a3097e48144dc4e07b65d67008e.png"},81016:(e,t,n)=>{n.d(t,{Z:()=>s});const s=n.p+"assets/images/psremoting_07-822e87d6dcbc72facc753d7bb8c2f6f9.png"},72526:(e,t,n)=>{n.d(t,{Z:()=>s});const s=n.p+"assets/images/psremoting_08-7033312a55483d99dc3e1e2d80b48274.png"},7135:(e,t,n)=>{n.d(t,{Z:()=>s});const s=n.p+"assets/images/psremoting_09-10edea638bdd05eb2a908f09155505c1.png"},3064:(e,t,n)=>{n.d(t,{Z:()=>s});const s=n.p+"assets/images/psremoting_10-7b520530c7ff0f26ebc26ce3b365a4a7.png"},84420:(e,t,n)=>{n.d(t,{Z:()=>s});const s=n.p+"assets/images/psremoting_auth_01-baf9bf3c09ac2f3c208ecbaf24694a6e.png"},74879:(e,t,n)=>{n.d(t,{Z:()=>s});const s=n.p+"assets/images/psremoting_auth_02-a3ae175d4cfd49d1de2c7cf02e4a8a99.png"},7676:(e,t,n)=>{n.d(t,{Z:()=>s});const s=n.p+"assets/images/psremoting_auth_03-b071515592a6aa60d841f8a0f497350b.png"},99860:(e,t,n)=>{n.d(t,{Z:()=>s});const s=n.p+"assets/images/psremoting_copy-item_01-9a5c9aa65d7f977b8df9fecaf6a965cc.png"},46212:(e,t,n)=>{n.d(t,{Z:()=>s});const s=n.p+"assets/images/psremoting_copy-item_02-c5140316a06de6dd09d33060091ed26b.png"},90909:(e,t,n)=>{n.d(t,{Z:()=>s});const s=n.p+"assets/images/psremoting_invoke-command_01-847b111d7162dc08fa5efa9d2565254b.png"},69741:(e,t,n)=>{n.d(t,{Z:()=>s});const s=n.p+"assets/images/psremoting_invoke-command_02-e3e99ef765c9aeb2f3e8c2745b2fc4c3.png"},89678:(e,t,n)=>{n.d(t,{Z:()=>s});const s=n.p+"assets/images/psremoting_invoke-command_03-3eb0109e76f7529cf1b32b4767d8b50b.png"},17953:(e,t,n)=>{n.d(t,{Z:()=>s});const s=n.p+"assets/images/psremoting_invoke-command_04-7e7d2b98b8d2e382d411b87e24a83661.png"},94728:(e,t,n)=>{n.d(t,{Z:()=>s});const s=n.p+"assets/images/psremoting_invoke-command_05-60552e02bd41a339dc1391c1cc6d3c42.png"},77747:(e,t,n)=>{n.d(t,{Z:()=>s});const s=n.p+"assets/images/psremoting_invoke-command_06-9240c20bade96126117d8fe5f88b6fae.png"},43259:(e,t,n)=>{n.d(t,{Z:()=>s});const s=n.p+"assets/images/winrm_firewall01-ab400d5132e59da13aeec10e56736035.png"},45611:(e,t,n)=>{n.d(t,{Z:()=>s});const s=n.p+"assets/images/wmi_remote_01-4a779f1c3c5b6afaf57e2d672b46d75c.png"},51542:(e,t,n)=>{n.d(t,{Z:()=>s});const s=n.p+"assets/images/wmi_remote_02-f6c29858e3258baf5895dbad101dabba.png"},54942:(e,t,n)=>{n.d(t,{Z:()=>s});const s=n.p+"assets/images/wmi_remote_03-a7ba7759d639dcdce16763347172d17b.png"},64521:(e,t,n)=>{n.d(t,{Z:()=>s});const s=n.p+"assets/images/wmi_remote_04-14a90b23a5ec976cbc34bf06cde18634.png"},65811:(e,t,n)=>{n.d(t,{Z:()=>s});const s=n.p+"assets/images/wmi_remote_05-881d904a1c1f18076af02fced0239843.png"},24778:(e,t,n)=>{n.d(t,{Z:()=>s});const s=n.p+"assets/images/wmi_remote_06-729a728ebbb57bbbf76993d3affc053c.png"}}]);